<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Avi Press</title>
        <link rel="icon" type="image/png" sizes="32x32" href="images/dwarf-icon.png">
        <link rel="stylesheet" href="../css/normalize.css" />
        <link rel="stylesheet" href="../css/skeleton.css" />
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
        <script async defer src="https://buttons.github.io/buttons.js"></script>
    </head>
    <body>
        <div class="content">
            <div class="row">
                <div class="two columns side-nav">
                    <a href="../" class="no-style"><h4>Avi Press</h4></a>
                    <table class="nav-table">
                        <tbody class="nav-table">
                            <tr class="nav-table">
                                <td class="nav-table"><a class="no-style" href="../">Home</a></td>
                            </tr>
                            <tr class="nav-table">
                                <td class="nav-table"><a class="no-style" href="../archive.html">Posts</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="ten columns">
                    <div class="info">
    Posted on August 25, 2017
    
</div>

<h2 id="easy-database-access-with-haskell-and-postgresql-simple">Easy database access with Haskell and postgresql-simple</h2>
<p>Working with a database can be a challenging task for newcomers to Haskell. For me, it became a non trivial hurdle on the road to productivity with the language. With libraries like persistent, unfamiliar Template Haskell combined with the complex types involved ramped the learning curve making it hard to get much done.</p>
<p>I recently found myself needing to write a script to import some data from a data dump file into postgresql (It was a dump of artists from <a href="https://musicbrainz.org/">musicbrainz</a> if you’re interested). This time, I gave <code>postgrseql-simple</code> a shot and it was surprisingly easy to use! My script ended up being small and quick to write. If you find yourself just needing a simple and straightforward way to talk to a database, it’s a great choice. I’ll give a brief intro to what I did here, and maybe it can help others get the ball rolling for their own projects.</p>
<p>Mapping a data type to a database table and getting a connection is easy:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import           </span><span class="dt">Control.Monad.IO.Class</span>
<span class="kw">import           </span><span class="dt">Data.String.Utils</span>
<span class="kw">import           </span><span class="dt">Database.PostgreSQL.Simple</span>
<span class="kw">import           </span><span class="dt">Database.PostgreSQL.Simple.FromRow</span>
<span class="kw">import           </span><span class="dt">Database.PostgreSQL.Simple.ToRow</span>
<span class="kw">import           </span><span class="dt">Database.PostgreSQL.Simple.ToField</span>

<span class="co">-- The data type we want as a table in the database. </span>
<span class="co">-- We define our data models as regular data </span>
<span class="co">-- records, no template haskell needed!</span>
<span class="kw">data</span> <span class="dt">Artist</span> <span class="fu">=</span> <span class="dt">Artist</span>
  {<span class="ot"> musicbrainzId ::</span> <span class="dt">String</span>
  ,<span class="ot"> name ::</span> <span class="dt">String</span>
  }

<span class="co">-- Define a mapping from rows to be unmarshaled </span>
<span class="co">-- into your data type. Just use one literal </span>
<span class="co">-- `&lt;*&gt; field` for each field in your record</span>
<span class="kw">instance</span> <span class="dt">FromRow</span> <span class="dt">Artist</span> <span class="kw">where</span>
    fromRow <span class="fu">=</span> <span class="dt">Artist</span> <span class="fu">&lt;$&gt;</span> field <span class="fu">&lt;*&gt;</span> field


<span class="co">-- ... And the same for marshaling your datatype into a db row</span>
<span class="kw">instance</span> <span class="dt">ToRow</span> <span class="dt">Artist</span> <span class="kw">where</span>
  toRow a <span class="fu">=</span> [toField (musicbrainzId a), toField (name a)]</code></pre></div>
<p>We can easily grab a connection like so:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">main <span class="fu">=</span> <span class="kw">do</span>
  conn <span class="ot">&lt;-</span> connect defaultConnectInfo { connectUser <span class="fu">=</span> <span class="st">&quot;my_username&quot;</span>
                                     , connectDatabase <span class="fu">=</span> <span class="st">&quot;my_dbname&quot;</span>
                                     }
  <span class="co">-- do some stuff</span></code></pre></div>
<p>Now we’re ready to go! Lets write a function that can insert an artist record. We can now write:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">insertArtist ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">Artist</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Int64</span>
insertArtist conn artist <span class="fu">=</span>
  execute conn
    <span class="st">&quot;insert into artist (musicbrainz_id, name) values (?, ?)&quot;</span> artist</code></pre></div>
<p>Some things I like about this library:</p>
<ul>
<li>Our DB facing methods only need the IO monad, so it’s less likely you’ll need to reach for monad transformers to use this productively.</li>
<li>The database connection is explicitly passed around rather than obfuscated behind a more complicated type.</li>
</ul>
<p>The trade-off in type safety is well worth the ease of use if, like me, you’re not an expert Haskell developer. To tie everything together and make things a little more usable, lets also make our insert function print its progress in the entire import:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">main <span class="fu">=</span> <span class="kw">do</span>
  conn <span class="ot">&lt;-</span> connect defaultConnectInfo { connectUser <span class="fu">=</span> <span class="st">&quot;my_username&quot;</span>
                                     , connectDatabase <span class="fu">=</span> <span class="st">&quot;my_dbname&quot;</span>
                                     }
  <span class="kw">let</span> artists <span class="fu">=</span> <span class="fu">...</span> <span class="co">-- some unrelated file parsing</span>
  mapM_ (uncurry <span class="fu">$</span> insertAndPrintCount conn) <span class="fu">$</span> zip [<span class="dv">1</span> <span class="fu">..</span>] artists
  close conn
  return ()

<span class="ot">insertAndPrintCount ::</span> <span class="dt">Connection</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Artist</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Int64</span>
insertAndPrintCount  conn count artist <span class="fu">=</span> <span class="kw">do</span>
  insertedId <span class="ot">&lt;-</span> execute conn
    <span class="st">&quot;insert into artist (musicbrainz_id, name) values (?, ?)&quot;</span> artist
  printf <span class="st">&quot;total inserted: %d\n&quot;</span> count
  return insertedId</code></pre></div>

                </div>
            </div>
            <div class="footer">
                Site proudly generated by
                <a href="http://jaspervdj.be/hakyll">Hakyll</a>
            </div>
        </div>

        <script>
         (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

         ga('create', 'UA-68573197-1', 'auto');
         ga('send', 'pageview');
        </script>
    </body>
</html>
